<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unico Kitchen üç≥</title>
<style>
/* ===== GENERAL STYLES ===== */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: #fff8f5;
  color: #333;
}
header {
  background: linear-gradient(90deg, #ff7e5f, #feb47b);
  color: white;
  text-align: center;
  padding: 20px;
  font-size: 2rem;
  font-weight: bold;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

/* ===== CONTAINER ===== */
.container {
  max-width: 960px;
  margin: auto;
  padding: 20px;
}

/* ===== LOGIN BOX ===== */
.login-box {
  background: #fff;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  text-align: center;
}
.login-box input {
  width: 80%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
}
.login-box button {
  background: #ff6f3c;
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1rem;
}
.login-box button:hover {
  background: #ff8f56;
}

/* ===== DASHBOARD ===== */
.hidden { display: none; }
h2 { margin-top: 0; }
nav {
  display: flex;
  justify-content: space-around;
  margin: 20px 0;
}
nav button {
  flex: 1;
  margin: 5px;
  padding: 12px;
  background: #feb47b;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
nav button:hover {
  background: #ff7e5f;
  color: white;
}

/* ===== CARDS ===== */
.card {
  background: #fff;
  padding: 20px;
  margin: 15px 0;
  border-radius: 15px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  transition: 0.3s;
}
.card:hover { transform: translateY(-3px); }
.recipe-img {
  width: 100%;
  border-radius: 12px;
  margin-bottom: 10px;
}

/* ===== MISSING INGREDIENTS ===== */
.missing {
  color: red;
  font-weight: bold;
}

/* ===== OFFER BANNER ===== */
.offer-banner {
  background: #ffe0c1;
  color: #e85a2a;
  text-align: center;
  padding: 10px;
  border-radius: 12px;
  font-weight: bold;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<header>üç≥ Unico Kitchen</header>

<div class="container">
  <!-- LOGIN -->
  <div id="loginSection" class="login-box">
    <h2>Enter Your Unique Code</h2>
    <input type="text" id="studentCode" placeholder="e.g. UNI01X8">
    <button onclick="login()">Login</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <div class="offer-banner">üî• Special Offer: 10% Off Market Items!</div>
    <h2 id="studentName"></h2>
    <p>Available Tokens: <span id="tokenCount">0</span></p>

    <nav>
      <button onclick="showTab('recipes')">Recipes</button>
      <button onclick="showTab('fridge')">Fridge</button>
      <button onclick="showTab('shop')">Shop</button>
    </nav>

    <div id="recipes" class="tabContent"></div>

    <div id="fridge" class="tabContent hidden">
      <h3>Your Fridge</h3>
      <div id="fridgeList">No items yet</div>
    </div>

    <div id="shop" class="tabContent hidden">
      <h3>Shop Items</h3>
      <div id="shopList"></div>
    </div>
  </div>
</div>

<script>
const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwems2cjfCGJYjpLfTmGDcyS-OTiA-E5jYP1ZDXcFFyDuUR5jYs52kax6zFcKXVTbl57Q/exec";
const WHATSAPP_NUMBER = "254798459336";
let student = null;

// ===== LOGIN =====
async function login() {
  const code = document.getElementById("studentCode").value.trim();
  if(!code) return alert("Enter your student code!");
  
  const res = await fetch(`${GAS_WEBAPP_URL}?action=getStudents`);
  const students = await res.json();
  student = students.find(s => s.Code === code);
  if(!student) return alert("Invalid code, try again!");

  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  document.getElementById("studentName").innerText = `üëã Welcome, ${student.Name}`;
  document.getElementById("tokenCount").innerText = student.Tokens;
  updateFridgeList();
  loadAvailableRecipes();
  loadShop();
}

// ===== SHOW/HIDE TABS =====
function showTab(tab) {
  document.querySelectorAll(".tabContent").forEach(t => t.classList.add("hidden"));
  document.getElementById(tab).classList.remove("hidden");
}

// ===== UPDATE FRIDGE DISPLAY =====
function updateFridgeList() {
  const list = document.getElementById("fridgeList");
  const items = student["Fridge Items"].split(",").map(i => i.trim()).filter(i=>i);
  list.innerHTML = items.length > 0 ? items.join(", ") : "No items yet";
}

// ===== LOAD AVAILABLE RECIPES =====
async function loadAvailableRecipes() {
  const res = await fetch(`${GAS_WEBAPP_URL}?action=getRecipes`);
  const recipes = await res.json();
  const fridgeItems = student["Fridge Items"].split(",").map(i => i.trim());
  const container = document.getElementById("recipes");
  container.innerHTML = "<h3>Recipes You Can Cook</h3>";

  recipes.forEach(r => {
    const ingredients = r.Ingredients.split(",").map(i => i.trim());
    const missing = ingredients.filter(i => !fridgeItems.includes(i));

    if(missing.length > 2) return; // skip if more than 2 missing

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <img src="${r.Image}" alt="${r.Name}" class="recipe-img" />
      <h4>${r.Name}</h4>
      <p>‚è± ${r["Time (mins)"]} mins</p>
      <p>Ingredients: ${ingredients.map(i => fridgeItems.includes(i)?i:`<span class="missing">${i}</span>`).join(", ")}</p>
      <button onclick="cookRecipeWithMissing('${r.Name}')">
        ${missing.length === 0 ? "Cook Now" : `Add Missing (${missing.length}) + Cook`}
      </button>
    `;
    container.appendChild(div);
  });
}

// ===== COOK RECIPE WITH MISSING INGREDIENTS =====
async function cookRecipeWithMissing(recipeName) {
  const res = await fetch(`${GAS_WEBAPP_URL}?action=getRecipes`);
  const recipes = await res.json();
  const recipe = recipes.find(r => r.Name === recipeName);
  const fridgeItems = student["Fridge Items"].split(",").map(i => i.trim());
  const missing = recipe.Ingredients.split(",").map(i => i.trim()).filter(i => !fridgeItems.includes(i));

  // Handle missing ingredients via Mpesa
  for(let item of missing){
    const code = prompt(`Missing ingredient "${item}". Enter Mpesa payment code to add it:`);
    if(!code) return alert("You must pay to add missing ingredients.");
    alert(`Payment confirmed! "${item}" added to your fridge.`);
    student["Fridge Items"] += `, ${item}`;
  }

  updateFridgeList();

  // Send full recipe to WhatsApp
  const message = `
üç≥ Unico Kitchen
üë©‚Äçüç≥ Student: ${student.Name}
üìò Recipe: ${recipe.Name}
üßæ Ingredients: ${recipe.Ingredients}
‚è± Time: ${recipe["Time (mins)"]} mins
`.trim();
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, "_blank");

  loadAvailableRecipes();
}

// ===== LOAD SHOP =====
async function loadShop() {
  const res = await fetch(`${GAS_WEBAPP_URL}?action=getShop`);
  const shop = await res.json();
  const container = document.getElementById("shopList");
  container.innerHTML = "";

  shop.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h4>${item.Item}</h4>
      <p>üí∞ KES ${item.Price} ‚Äî <b>${item.Offer}% Off</b></p>
      <button onclick="addToFridge('${item.Item}')">Add to Fridge (Mpesa)</button>
    `;
    container.appendChild(div);
  });
}

// ===== ADD ITEM TO FRIDGE =====
function addToFridge(item) {
  const code = prompt(`Enter Mpesa payment code for "${item}":`);
  if(!code) return;
  alert(`Payment confirmed! "${item}" added to fridge.`);
  student["Fridge Items"] += `, ${item}`;
  updateFridgeList();
  loadAvailableRecipes();
}
</script>

</body>
</html>
